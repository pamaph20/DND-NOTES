<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTOCOL B-13 // OMEGA</title>
    <style>
        /* --- 1. CORE VARIABLES & FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700;900&display=swap');

        :root {
            --c-void: #010103;
            --c-core: #00f3ff;   
            --c-dim: rgba(0, 243, 255, 0.1);
            --c-success: #00ff9d;
            --c-warn: #ffaa00;
            --c-danger: #ff2a2a;
            --c-medic: #0088ff;
            --c-white: #e0e0e0;
            
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
            --scan-color: rgba(0, 243, 255, 0.05);
        }

        * { box-sizing: border-box; user-select: none; cursor: crosshair; }

        body {
            background-color: var(--c-void);
            color: var(--c-core);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: filter 0.1s;
        }

        /* --- 2. CRT & ATMOSPHERE FX --- */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 900;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
        }
        
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 890;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
        }

        .scan-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 10px; z-index: 895;
            background: var(--c-dim); opacity: 0.3;
            animation: scanMove 8s linear infinite; pointer-events: none;
        }

        .grid-floor {
            position: absolute; width: 200%; height: 100%; bottom: -50%; left: -50%;
            background: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(600px) rotateX(60deg);
            animation: gridMove 10s linear infinite;
            z-index: 0; pointer-events: none;
            mask-image: linear-gradient(to top, black 0%, transparent 80%);
        }

        /* --- 3. BOOT SEQUENCE --- */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 50px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--c-success);
        }
        .boot-line { margin-bottom: 2px; opacity: 0; animation: fadeIn 0.1s forwards; }

        /* --- 4. UI LAYOUT --- */
        .ui-container {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; padding: 20px;
            background: radial-gradient(circle at center, transparent 0%, #000 140%);
        }

        header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 1px solid var(--c-dim); padding-bottom: 15px; margin-bottom: 20px;
            background: linear-gradient(90deg, transparent, rgba(0,243,255,0.05), transparent);
        }
        .header-left h1 { margin: 0; font-family: 'JetBrains Mono'; font-size: 2.2rem; letter-spacing: -3px; text-shadow: 0 0 10px var(--c-core); line-height: 1; }
        .header-left small { font-size: 0.7rem; letter-spacing: 4px; color: #556; display: block; margin-top: 5px; }
        
        .surge-meter {
            font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--c-danger);
            border: 1px solid var(--c-danger); padding: 5px 15px; margin-right: 20px;
            background: rgba(255, 42, 42, 0.05); display: inline-block; vertical-align: bottom;
        }

        .round-badge {
            font-size: 1.8rem; font-weight: 900; padding: 5px 30px;
            border: 2px solid var(--c-core); color: var(--c-core);
            background: rgba(0,0,0,0.5); box-shadow: 0 0 15px var(--c-dim);
            text-transform: uppercase; transition: 0.5s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        /* --- 5. CONSOLE LOG (NEW) --- */
        #console-log {
            position: absolute; bottom: 20px; left: 20px; width: 300px; height: 200px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
            color: #667; overflow: hidden; pointer-events: none;
            display: flex; flex-direction: column-reverse; /* Newest at bottom visually if we prepend, but we append */
            mask-image: linear-gradient(to bottom, transparent, black 20%);
            z-index: 800;
        }
        .log-entry { margin-bottom: 4px; text-shadow: 0 0 2px currentColor; }
        .log-entry span { opacity: 0.5; margin-right: 5px; }
        .log-entry.sys { color: var(--c-white); }
        .log-entry.warn { color: var(--c-warn); }
        .log-entry.crit { color: var(--c-danger); }
        .log-entry.ok { color: var(--c-success); }

        /* --- 6. THE MAP --- */
        .viewport {
            flex-grow: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            border: 1px solid var(--c-dim);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
            overflow: hidden;
        }

        .hub-svg { width: 100%; height: 100%; max-width: 1000px; overflow: visible; }
        
        /* Connectors */
        .connector-bg { stroke: #112; stroke-width: 10; fill: none; stroke-linecap: square; opacity: 0.2; }
        
        .beam-line {
            stroke: var(--c-success); stroke-width: 4; fill: none; stroke-linecap: round;
            stroke-dasharray: 1000; stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 8px var(--c-success)); opacity: 0.9;
        }
        .beam-active { animation: drawBeam 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* Trinity Flash */
        .trinity-flash { fill: #fff; opacity: 0; pointer-events: none; }
        .trinity-active { animation: flashBang 3s forwards; }

        /* Nodes */
        .node-group { cursor: pointer; transition: 0.3s var(--ease-out); }
        .node-group:hover { transform: scale(1.1); }
        .node-bg { fill: rgba(0,0,0,0.9); stroke: var(--c-core); stroke-width: 2; transition: 0.3s; }
        .node-icon { fill: var(--c-core); font-size: 30px; text-anchor: middle; dominant-baseline: middle; transition: 0.3s; }
        .node-label { fill: var(--c-core); font-size: 12px; font-family: 'JetBrains Mono'; text-anchor: middle; opacity: 0.8; letter-spacing: 2px; }

        .node-group:hover .node-bg { fill: var(--c-dim); box-shadow: 0 0 30px var(--c-core); }
        .node-group:hover .node-icon { fill: #fff; }

        .node-group.completed .node-bg { stroke: var(--c-success); fill: rgba(0, 255, 157, 0.1); box-shadow: 0 0 20px var(--c-success); }
        .node-group.completed .node-icon { fill: var(--c-success); }
        .node-group.completed .node-label { fill: var(--c-success); }

        /* --- 7. MODAL WINDOW --- */
        .modal-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-layer.active { opacity: 1; pointer-events: all; }

        .terminal-window {
            width: 1100px; height: 650px;
            background: #050709;
            border: 1px solid var(--c-core);
            box-shadow: 0 0 100px rgba(0,0,0,1);
            display: grid; grid-template-columns: 55% 45%;
            transform: scale(0.95) translateY(20px); transition: 0.4s var(--ease-out);
            position: relative; overflow: hidden;
        }
        .modal-layer.active .terminal-window { transform: scale(1) translateY(0); }

        /* Scanline inside modal */
        .terminal-window::after {
            content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none;
        }

        .viz-container {
            border-right: 1px solid var(--c-core);
            background-image: 
                linear-gradient(var(--c-dim) 1px, transparent 1px),
                linear-gradient(90deg, var(--c-dim) 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        
        .data-container {
            padding: 40px; display: flex; flex-direction: column;
            background: linear-gradient(135deg, rgba(0,0,0,0) 60%, rgba(0,243,255,0.02) 100%);
        }

        .terminal-header { border-bottom: 2px solid var(--c-core); padding-bottom: 10px; margin-bottom: 20px; }
        .terminal-header h2 { margin: 0; font-size: 3rem; color: #fff; letter-spacing: 8px; line-height: 1; }
        
        .log-block {
            background: rgba(0,0,0,0.4); border-left: 4px solid #333;
            padding: 15px; margin-bottom: 15px;
            font-family: 'JetBrains Mono'; font-size: 0.9rem;
        }
        .log-label { font-size: 0.7rem; text-transform: uppercase; color: #666; display: block; margin-bottom: 8px; letter-spacing: 1px; }
        .log-content { color: #e0e0e0; line-height: 1.5; min-height: 45px; }

        .control-grid { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; z-index: 2; }
        
        .btn-action {
            background: transparent; border: 1px solid; padding: 20px;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.4rem;
            text-transform: uppercase; cursor: pointer; transition: 0.2s;
            position: relative; overflow: hidden; letter-spacing: 2px;
        }
        .btn-action::before {
            content:''; position: absolute; top:0; left:-100%; width:100%; height:100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.4s;
        }
        .btn-action:hover::before { left: 100%; }

        .btn-stab { border-color: var(--c-success); color: var(--c-success); box-shadow: inset 0 0 20px rgba(0,255,157,0.1); }
        .btn-stab:hover { background: var(--c-success); color: #000; box-shadow: 0 0 40px var(--c-success); }
        
        .btn-surge { border-color: var(--c-danger); color: var(--c-danger); box-shadow: inset 0 0 20px rgba(255,42,42,0.1); }
        .btn-surge:hover { background: var(--c-danger); color: #000; box-shadow: 0 0 40px var(--c-danger); }

        .close-modal {
            position: absolute; top: 20px; right: 20px; background: none; border: 1px solid #444; color: #444;
            width: 40px; height: 40px; font-size: 2rem; line-height: 40px; cursor: pointer; z-index: 20; transition: 0.2s;
        }
        .close-modal:hover { border-color: #fff; color: #fff; }

        /* --- 8. OVERLAYS & FX --- */
        #system-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #sys-title { font-size: 4rem; letter-spacing: 15px; color: #fff; margin-bottom: 20px; text-align: center; text-shadow: 0 0 30px var(--c-core); }
        #sys-body { font-family: 'JetBrains Mono'; color: var(--c-core); font-size: 1.2rem; text-align: center; max-width: 700px; line-height: 1.6; }

        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 150; }
        #fracture-layer { position: fixed; width: 100%; height: 100%; pointer-events: none; z-index: 160; display: none; }
        .shard { position: absolute; background: #000; border: 1px solid var(--c-danger); }

        /* Glitch Classes */
        .glitch-mode { animation: chromatic 0.1s infinite; filter: contrast(1.5) brightness(1.2) grayscale(100%); }
        @keyframes chromatic {
            0% { text-shadow: 4px 0 var(--c-danger), -4px 0 blue; transform: translate(3px, 0); }
            50% { text-shadow: -4px 0 var(--c-danger), 4px 0 blue; transform: translate(-3px, 0); }
            100% { text-shadow: 4px 0 var(--c-danger), -4px 0 blue; transform: translate(0, 3px); }
        }

        /* Animations */
        @keyframes gridMove { from { background-position: 0 0; } to { background-position: 0 60px; } }
        @keyframes scanMove { 0% { top: -10%; } 100% { top: 110%; } }
        @keyframes drawBeam { to { stroke-dashoffset: 0; } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes flashBang {
            0% { opacity: 0; } 10% { opacity: 1; fill: #fff; } 100% { opacity: 0.3; fill: var(--c-medic); }
        }

        /* Massive Failure */
        body.critical-failure { background-color: #1a0000; }
        body.critical-failure #system-overlay { background: rgba(20,0,0,0.98); opacity: 1; pointer-events: all; }
        body.critical-failure #sys-title { color: var(--c-danger); animation: glitchText 0.2s infinite; }
        @keyframes glitchText { 
            0% { opacity: 1; transform: skewX(0deg); } 20% { opacity: 0.8; transform: skewX(-20deg); } 40% { opacity: 1; transform: skewX(20deg); } 
        }

        /* Victory */
        body.victory { background: #00101a; }
        body.victory .round-badge { color: #fff; border-color: #fff; box-shadow: 0 0 50px #fff; background: #fff; color: #000; }

    </style>
</head>
<body>

    <!-- FX LAYERS -->
    <div class="crt-overlay"></div>
    <div class="scanlines"></div>
    <div class="scan-bar"></div>
    <div class="grid-floor"></div>
    <canvas id="particle-canvas"></canvas>
    <div id="fracture-layer"></div>

    <!-- SYSTEM MESSAGE OVERLAY -->
    <div id="system-overlay">
        <div id="sys-title">SYSTEM MESSAGE</div>
        <div id="sys-body">STANDBY...</div>
    </div>

    <!-- BOOT SCREEN -->
    <div id="boot-layer">
        <div id="boot-content"></div>
    </div>

    <!-- MAIN UI -->
    <div class="ui-container" id="main-ui" style="opacity: 0;">
        <header>
            <div class="header-left">
                <h1>PROTOCOL B-13</h1>
                <small>ENGINEERING DECK // TERMINAL 7</small>
            </div>
            <div class="header-center" style="flex-grow:1; text-align:center;">
                <span class="surge-meter" id="surge-display">SURGES: 0/4</span>
            </div>
            <div class="header-right">
                <div class="round-badge" id="badge-round">ROUND 1</div>
            </div>
        </header>

        <div class="viewport">
            <svg class="hub-svg" viewBox="0 0 800 500">
                <!-- Trinity Flash -->
                <polygon points="400,100 150,400 650,400" class="trinity-flash" id="trinity-glow" />

                <!-- Connector Backgrounds -->
                <line x1="400" y1="100" x2="150" y2="400" class="connector-bg" />
                <line x1="150" y1="400" x2="650" y2="400" class="connector-bg" />
                <line x1="650" y1="400" x2="400" y2="100" class="connector-bg" />

                <!-- PROGRESSIVE BEAMS -->
                <path d="M400 100 L150 400" class="beam-line" id="beam-1" />
                <path d="M150 400 L650 400" class="beam-line" id="beam-2" />
                <path d="M650 400 L400 100" class="beam-line" id="beam-3" />

                <!-- Nodes -->
                <g class="node-group" id="node-alpha" onclick="Game.openStation('alpha')">
                    <circle cx="400" cy="100" r="60" class="node-bg" />
                    <text x="400" y="105" class="node-icon">âš™</text>
                    <text x="400" y="180" class="node-label">ALPHA</text>
                </g>

                <g class="node-group" id="node-delta" onclick="Game.openStation('delta')">
                    <circle cx="150" cy="400" r="60" class="node-bg" />
                    <text x="150" y="405" class="node-icon">ðŸ’§</text>
                    <text x="150" y="480" class="node-label">DELTA</text>
                </g>

                <g class="node-group" id="node-zeta" onclick="Game.openStation('zeta')">
                    <circle cx="650" cy="400" r="60" class="node-bg" />
                    <text x="650" y="405" class="node-icon">âš¡</text>
                    <text x="650" y="480" class="node-label">ZETA</text>
                </g>
            </svg>
        </div>

        <!-- Console Log -->
        <div id="console-log">
            <div class="log-entry sys"><span>></span> SYSTEM READY</div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <button onclick="Game.medic()" style="background: transparent; border: 1px solid var(--c-medic); color: var(--c-medic); padding: 12px 50px; font-family: inherit; text-transform: uppercase; font-weight: 900; cursor: pointer; letter-spacing: 2px;">MEDIC ASSIST</button>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-layer" id="modal">
        <div class="terminal-window">
            <button class="close-modal" onclick="Game.closeModal()">Ã—</button>
            
            <div class="viz-container" id="viz-target"></div>

            <div class="data-container">
                <div class="terminal-header">
                    <h2 id="term-title">ALPHA</h2>
                </div>

                <div class="log-block">
                    <span class="log-label">DIAGNOSTIC DATA</span>
                    <div class="log-content" id="log-desc">Reading...</div>
                </div>

                <div class="log-block" style="border-color: var(--c-warn);">
                    <span class="log-label" style="color:var(--c-warn)">STABILIZATION PROTOCOL</span>
                    <div class="log-content" id="log-hint">Decrypting...</div>
                </div>

                <div class="log-block" style="border-color: var(--c-danger);">
                    <span class="log-label" style="color:var(--c-danger)">SURGE RISK</span>
                    <div class="log-content" id="log-fail">Calculating...</div>
                </div>

                <div class="control-grid">
                    <button class="btn-action btn-stab" onclick="Game.resolve(true)">STABILIZE</button>
                    <button class="btn-action btn-surge" onclick="Game.resolve(false)">FAIL / SURGE</button>
                </div>
            </div>
        </div>
    </div>

<script>
/* --- AUDIO SYSTEM (SYNTH) --- */
const AudioSys = {
    ctx: null,
    init: function() {
        if(!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    playTone: function(freq, type, duration, vol = 0.1) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    hover: function() { this.playTone(800, 'sine', 0.05, 0.05); },
    click: function() { this.playTone(1200, 'square', 0.1, 0.1); },
    success: function() { 
        this.playTone(400, 'sine', 0.2); 
        setTimeout(()=>this.playTone(600, 'sine', 0.2), 100);
        setTimeout(()=>this.playTone(800, 'sine', 0.4), 200);
    },
    fail: function() {
        this.playTone(150, 'sawtooth', 0.5, 0.2);
        this.playTone(100, 'sawtooth', 0.5, 0.2);
    },
    alarm: function() {
        this.playTone(800, 'square', 0.1, 0.2);
        setTimeout(()=>this.playTone(600, 'square', 0.1, 0.2), 100);
    }
};

/* --- PARTICLE SYSTEM --- */
const Particles = {
    ctx: null, canvas: null, particles: [],
    init: function() {
        this.canvas = document.getElementById('particle-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', ()=>this.resize());
        this.loop();
    },
    resize: function() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },
    spawn: function(x, y, color, count, speed) {
        for(let i=0; i<count; i++) {
            this.particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * speed,
                vy: (Math.random() - 0.5) * speed,
                life: 1.0,
                color: color
            });
        }
    },
    loop: function() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for(let i=this.particles.length-1; i>=0; i--) {
            let p = this.particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.02;
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.fillRect(p.x, p.y, 3, 3);
            if(p.life <= 0) this.particles.splice(i, 1);
        }
        requestAnimationFrame(()=>this.loop());
    }
};

/* --- GAME CONFIG --- */
const DB = {
    1: {
        color: '#00f3ff',
        name: "ROUND 1 // INITIALIZATION",
        alpha: { desc: "Gears grinding. Rotational variance detected.", hint: "Rotate gears in sequence. Listen to the rhythm.", fail: "SPARKS! Nearby stations take Damage." },
        delta: { desc: "Valves sweating. Coolant pressure low.", hint: "Tighten coupling. Turn valves slowly.", fail: "SPRAY! AGI Save or Slip. Floor slippery." },
        zeta: { desc: "Voltage spiking. Arc flash imminent.", hint: "Insulate misaligned wires.", fail: "SHOCK! Hands suffer tremors." }
    },
    2: {
        color: '#ffaa00',
        name: "ROUND 2 // ESCALATION",
        alpha: { desc: "Relay shuddering. Harmonic resonance critical.", hint: "Micro-increments. Sync rotation with pulse.", fail: "FEEDBACK! Delta & Zeta AGI Save." },
        delta: { desc: "Pipes rumbling. Integrity failing.", hint: "Adjust two valves simultaneously.", fail: "BLOWOUT! Coolant splash. All players -1 AGI." },
        zeta: { desc: "Board overheating. Circuits orange.", hint: "Re-route only at audible click.", fail: "SURGE! Random player Shock effect." }
    },
    3: {
        color: '#ff2a2a',
        name: "ROUND 3 // CRITICAL MASS",
        alpha: { desc: "Gears glowing white-hot. Structural failure.", hint: "Fine-tune tension. Light taps only.", fail: "BACKLASH! Take Damage. Delta DC +1." },
        delta: { desc: "Roaring like a geyser. Burst imminent.", hint: "Apply Counter-pressure immediately.", fail: "SCALD! Take Damage. Zeta DC +1." },
        zeta: { desc: "High pitch whine. Capacitor melting.", hint: "Ground connection first. Precise timing.", fail: "OVERLOAD! All make CON Save." }
    }
};

/* --- GAME ENGINE --- */
const Game = {
    round: 1,
    surges: 0,
    maxSurges: 4,
    status: { alpha: false, delta: false, zeta: false },
    currentId: null,

    init: function() {
        Particles.init();
        // Capture first click for Audio
        window.addEventListener('click', () => AudioSys.init(), { once: true });
        this.boot();
    },

    log: function(type, msg) {
        const div = document.getElementById('console-log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `<span>></span> ${msg}`;
        div.appendChild(entry);
        div.scrollTop = div.scrollHeight;
    },

    boot: function() {
        const txt = [
            "INITIALIZING BIOS...", "CHECKING MEMORY... OK", "LOADING CORE KERNEL... OK", 
            "MOUNTING DRIVES... OK", "ESTABLISHING UPLINK TO B-13... SUCCESS"
        ];
        const container = document.getElementById('boot-content');
        let i = 0;
        const int = setInterval(() => {
            if(i >= txt.length) {
                clearInterval(int);
                setTimeout(() => {
                    document.getElementById('boot-layer').style.display = 'none';
                    document.getElementById('main-ui').style.opacity = 1;
                    AudioSys.playTone(200, 'sine', 0.5);
                }, 500);
            } else {
                let p = document.createElement('div');
                p.className = 'boot-line';
                p.innerText = txt[i];
                container.appendChild(p);
                AudioSys.playTone(800, 'square', 0.05, 0.05);
                i++;
            }
        }, 400);
    },

    openStation: function(id) {
        if(this.status[id] || this.surges >= this.maxSurges) return;
        AudioSys.click();
        this.currentId = id;
        const rData = DB[this.round][id];
        
        document.getElementById('term-title').innerText = id.toUpperCase();
        this.scrambleText('log-desc', rData.desc);
        this.scrambleText('log-hint', rData.hint);
        this.scrambleText('log-fail', rData.fail);
        
        document.getElementById('viz-target').innerHTML = Viz.render(id, this.round, 'neutral');
        document.documentElement.style.setProperty('--c-core', DB[this.round].color);
        document.getElementById('modal').classList.add('active');
        
        this.log('sys', `ACCESSING NODE ${id.toUpperCase()}...`);
    },

    closeModal: function() {
        AudioSys.click();
        document.getElementById('modal').classList.remove('active');
    },

    resolve: function(success) {
        if(success) {
            AudioSys.success();
            this.log('ok', `${this.currentId.toUpperCase()} STABILIZED`);
            document.getElementById('viz-target').innerHTML = Viz.render(this.currentId, this.round, 'success');
            this.status[this.currentId] = true;
            document.getElementById('node-'+this.currentId).classList.add('completed');
            
            // Particles
            const rect = document.getElementById('viz-target').getBoundingClientRect();
            Particles.spawn(rect.left + rect.width/2, rect.top + rect.height/2, '#00ff9d', 30, 5);

            setTimeout(() => {
                this.closeModal();
                this.checkRound();
            }, 1500);
        } else {
            AudioSys.fail();
            this.log('crit', `SURGE DETECTED IN ${this.currentId.toUpperCase()}`);
            document.getElementById('viz-target').innerHTML = Viz.render(this.currentId, this.round, 'fail');
            this.triggerSurge();
        }
    },

    triggerSurge: function() {
        this.surges++;
        document.getElementById('surge-display').innerText = `SURGES: ${this.surges}/${this.maxSurges}`;
        
        // Particles
        Particles.spawn(window.innerWidth/2, window.innerHeight/2, '#ff2a2a', 50, 15);
        
        // FX
        const layer = document.getElementById('fracture-layer');
        layer.style.display = 'block';
        for(let i=0; i<3; i++) {
            let div = document.createElement('div');
            div.className = 'shard';
            div.style.top = Math.random()*90+'%'; div.style.left = Math.random()*90+'%';
            div.style.width = Math.random()*200+'px'; div.style.height = Math.random()*50+'px';
            div.style.clipPath = `polygon(${Math.random()*100}% 0%, 100% ${Math.random()*100}%, 0% 100%)`;
            div.style.transform = `rotate(${Math.random()*360}deg)`;
            div.animate([{opacity:1, transform:'scale(1)'}, {opacity:0, transform:'scale(0.5) translate(20px, 20px)'}], {duration: 1000, fill:'forwards'});
            layer.appendChild(div);
        }

        document.body.classList.add('glitch-mode');
        setTimeout(() => document.body.classList.remove('glitch-mode'), 500);

        if(this.surges >= this.maxSurges) {
            setTimeout(() => this.totalFailure(), 1000);
        }
    },

    totalFailure: function() {
        this.closeModal();
        document.body.classList.add('critical-failure');
        
        // Create massive fracture
        const layer = document.getElementById('fracture-layer');
        for(let i=0; i<60; i++) {
            let div = document.createElement('div');
            div.className = 'shard';
            div.style.top = Math.random()*100+'%'; div.style.left = Math.random()*100+'%';
            div.style.width = Math.random()*400+'px'; div.style.height = Math.random()*200+'px';
            div.style.clipPath = `polygon(${Math.random()*100}% 0%, 100% ${Math.random()*100}%, 0% 100%)`;
            layer.appendChild(div);
        }

        AudioSys.alarm();
        const overlay = document.getElementById('system-overlay');
        document.getElementById('sys-title').innerText = "TERMINAL LOCKOUT";
        document.getElementById('sys-title').style.color = "#ff2a2a";
        document.getElementById('sys-body').innerText = "CATASTROPHIC FAILURE // REACTOR UNSAFE";
        overlay.style.opacity = 1;
    },

    checkRound: function() {
        if(this.status.alpha && this.status.delta && this.status.zeta) {
            
            // 1. Fire the Beam for this round
            AudioSys.playTone(200, 'sine', 1.5);
            document.getElementById('beam-'+this.round).classList.add('beam-active');
            this.log('sys', `CIRCUIT ${this.round} LOCKED`);

            if(this.round < 3) {
                setTimeout(() => {
                    // Overlay Message (No popup)
                    this.displayMessage(`ROUND ${this.round} COMPLETE`, `INITIATING PHASE ${this.round+1}...`, 3000, () => {
                        this.round++;
                        this.status = { alpha: false, delta: false, zeta: false };
                        // Reset UI
                        document.querySelectorAll('.node-group').forEach(n => n.classList.remove('completed'));
                        
                        const badge = document.getElementById('badge-round');
                        badge.innerText = DB[this.round].name;
                        badge.style.borderColor = DB[this.round].color;
                        badge.style.color = DB[this.round].color;
                        
                        this.log('warn', `ENTERING PHASE ${this.round}`);
                    });
                }, 1500); 
            } else {
                // Final Victory
                setTimeout(() => {
                    document.getElementById('trinity-glow').classList.add('trinity-active');
                    Particles.spawn(window.innerWidth/2, window.innerHeight/2, '#fff', 100, 20);
                    AudioSys.playTone(800, 'sine', 2);
                    setTimeout(() => this.victory(), 2000);
                }, 1500);
            }
        }
    },

    displayMessage: function(title, body, time, callback) {
        const overlay = document.getElementById('system-overlay');
        document.getElementById('sys-title').innerText = title;
        document.getElementById('sys-body').innerText = body;
        overlay.style.opacity = 1;
        setTimeout(() => {
            overlay.style.opacity = 0;
            if(callback) callback();
        }, time);
    },

    victory: function() {
        document.body.classList.add('victory');
        this.displayMessage("SYSTEM STABILIZED", "POWER DISTRIBUTION OPTIMAL // BRIDGE UNLOCKED", 6000);
        document.getElementById('badge-round').innerText = "ONLINE";
        document.getElementById('badge-round').style.color = "#fff";
        document.getElementById('badge-round').style.borderColor = "#fff";
        this.log('ok', 'SYSTEM STABILIZATION COMPLETE');
    },

    scrambleText: function(id, txt) {
        const el = document.getElementById(id);
        const chars = 'ABCDEF0123456789@#';
        let i = 0;
        clearInterval(el.int);
        el.int = setInterval(() => {
            el.innerText = txt.split('').map((c, idx) => (idx < i ? txt[idx] : chars[Math.floor(Math.random()*chars.length)])).join('');
            if(i >= txt.length) clearInterval(el.int);
            i += 1/2;
        }, 20);
    },
    
    medic: function() {
        AudioSys.click();
        this.log('sys', 'MEDIC ASSISTANCE REQUESTED...');
        const b = event.target;
        b.innerText = "TREATING..."; b.style.background = "var(--c-medic)"; b.style.color="#000";
        setTimeout(()=>{ b.innerText="MEDIC: STABILIZE CREW"; b.style.background="transparent"; b.style.color="var(--c-medic)"; }, 1500);
    }
};

/* --- VISUALIZERS --- */
const Viz = {
    render: function(id, r, s) {
        if(id==='alpha') return this.alpha(r,s);
        if(id==='delta') return this.delta(r,s);
        if(id==='zeta') return this.zeta(r,s);
    },
    alpha: function(r,s) {
        let c = s==='success'?'#00ff9d':(s==='fail'?'#ff2a2a':DB[r].color);
        let sp = r===1?'8s':(r===2?'4s':'1s');
        if(s==='success') sp='20s';
        return `<svg width="300" height="300" viewBox="0 0 200 200">
            <circle cx="100" cy="100" r="90" fill="none" stroke="${c}" stroke-width="1" opacity="0.3"/>
            <g>
                <animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="${sp}" repeatCount="indefinite"/>
                <path d="M100,10 L110,10 L115,25 L130,30 L145,20 L155,25 L150,40 L165,50 L180,45 L185,55 L170,65 L175,80 L190,85 L190,95 L175,100 L175,115 L190,120 L185,130 L170,135 L165,150 L180,160 L170,170 L155,165 L150,180 L135,185 L130,170 L115,175 L110,190 L100,190 L90,190 L85,175 L70,170 L65,185 L50,180 L45,165 L30,170 L20,160 L35,150 L30,135 L15,130 L10,120 L25,115 L25,100 L10,95 L10,85 L25,80 L30,65 L15,55 L20,45 L35,50 L50,40 L45,25 L55,20 L70,30 L85,25 L90,10 Z" fill="none" stroke="${c}" stroke-width="2"/>
                <circle cx="100" cy="100" r="50" fill="none" stroke="${c}" stroke-width="4" stroke-dasharray="10,5"/>
            </g>
            <text x="100" y="105" fill="${c}" font-family="monospace" font-size="10" text-anchor="middle">${s==='success'?'LOCKED':'ROTATING'}</text>
        </svg>`;
    },
    delta: function(r,s) {
        let c = s==='success'?'#00ff9d':(s==='fail'?'#ff2a2a':DB[r].color);
        // Fix: Liquid fills from bottom (y=180 is bottom)
        let fillPct = r===1?0.5:(r===2?0.7:0.9);
        if(s==='success') fillPct=0.5; if(s==='fail') fillPct=1.0;
        let h = 160 * fillPct; 
        let y = 180 - h; // 180 minus height pushes rect UP
        
        return `<svg width="300" height="300" viewBox="0 0 200 200">
            <rect x="60" y="20" width="80" height="160" rx="5" fill="none" stroke="#333" stroke-width="4"/>
            <rect x="60" y="20" width="80" height="160" rx="5" fill="none" stroke="${c}" stroke-width="2"/>
            <rect x="65" y="${y}" width="70" height="${h}" fill="${c}" opacity="0.6">
                <animate attributeName="height" values="${h};${h+5};${h}" dur="2s" repeatCount="indefinite"/>
                <animate attributeName="y" values="${y};${y-5};${y}" dur="2s" repeatCount="indefinite"/>
            </rect>
            <circle cx="80" cy="160" r="3" fill="${c}"><animate attributeName="cy" from="160" to="30" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values="1;0" dur="2s" repeatCount="indefinite"/></circle>
            <text x="20" y="100" fill="${c}" font-family="monospace" font-size="12" transform="rotate(-90 20,100)">${Math.floor(fillPct*100)} PSI</text>
        </svg>`;
    },
    zeta: function(r,s) {
        let c = s==='success'?'#00ff9d':(s==='fail'?'#ff2a2a':DB[r].color);
        let chaos = s==='fail'?100:(s==='success'?0:(r*20));
        let path = "M0,100 ";
        for(let i=0;i<=20;i++){ path += `L${i*10},${100+(Math.random()*chaos - chaos/2)} `; }
        let dur = s==='fail'?'0.05s':'0.5s'; if(s==='success') { path="M0,100 L200,100"; dur="0s"; }
        return `<svg width="300" height="300" viewBox="0 0 200 200">
            <rect width="200" height="200" fill="rgba(0,0,0,0.2)"/>
            <path d="M0,50 L200,50 M0,150 L200,150 M100,0 L100,200" stroke="${c}" stroke-width="1" opacity="0.2"/>
            <path d="${path}" fill="none" stroke="${c}" stroke-width="3">
                <animate attributeName="d" dur="${dur}" repeatCount="indefinite" values="${path}; ${path.replace(/100/g,'110')}; ${path}"/>
            </path>
        </svg>`;
    }
};

Game.init();
</script>
</body>
</html>
